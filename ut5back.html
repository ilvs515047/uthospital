<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æè¡€æ´»å‹•å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-100 min-h-screen py-10 px-4 font-sans">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8">
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800">âš™ï¸ æ´»å‹•è¡¨å–®è¨­è¨ˆå™¨</h1>
            <span class="text-sm bg-blue-100 text-blue-800 py-1 px-3 rounded-full">ç®¡ç†å“¡æ¨¡å¼</span>
        </div>

        <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-100 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-bold mb-2">æ´»å‹•æ¨™é¡Œ (é¡¯ç¤ºåœ¨å‰å°)</label>
                <input type="text" id="formTitle" value="æè¡€æ´»å‹•å ±å" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-bold mb-2">ç®¡ç†å“¡å¯†ç¢¼</label>
                <input type="password" id="adminPwd" value="1234" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500">
            </div>
        </div>

        <div id="fields-container" class="space-y-4 mb-8">
            </div>

        <div class="flex flex-col md:flex-row gap-4 border-t pt-6">
            <button onclick="addField('text')" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-700 font-medium">
                + æ–°å¢æ–‡å­—é¡Œ (å§“å/é›»è©±)
            </button>
            <button onclick="addField('radio_limit')" class="px-4 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-800 rounded font-medium">
                + æ–°å¢é™é‡é¸å–® (æ™‚æ®µ/è´ˆå“)
            </button>
        </div>

        <div class="mt-10 flex flex-col md:flex-row justify-between items-center gap-4">
            <button onclick="clearDatabase()" class="w-full md:w-auto px-4 py-3 bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 rounded-lg font-bold flex items-center justify-center gap-2">
                ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰å ±åè³‡æ–™
            </button>
            
            <button onclick="saveConfig()" class="w-full md:w-auto px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white text-lg font-bold rounded-lg shadow-lg">
                å„²å­˜è¨­å®šä¸¦ç™¼ä½ˆ
            </button>
        </div>
    </div>

    <script>
        // â–¼â–¼â–¼ è«‹æ›¿æ›æˆä½ çš„ GAS ç¶²å€ â–¼â–¼â–¼
        const API_URL = "https://script.google.com/macros/s/AKfycbzbMh6rc44g7jaascRCiHcmz2KSDYKOda5Gs4P0UN86yikb06QYh3ja7r_pXdUshGCE7w/exec"; 
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        // é é¢è¼‰å…¥ï¼šè®€å–èˆŠè¨­å®š
        window.onload = async function() {
            Swal.showLoading();
            try {
                const res = await fetch(API_URL + "?action=getSettings").then(r => r.json());
                Swal.close();
                if(res.success && res.config) {
                    document.getElementById('formTitle').value = res.config.title;
                    res.config.fields.forEach(f => renderField(f));
                } else {
                    // é è¨­åˆå§‹åŒ–æ¬„ä½
                    renderField({ type: 'text', label: 'å§“å' });
                    renderField({ type: 'text', label: 'é›»è©±' });
                    renderField({ type: 'radio_limit', label: 'é¸æ“‡æ™‚æ®µ', options: [{label:'13:00-14:00', limit:6}] });
                }
            } catch(e) {
                Swal.fire('éŒ¯èª¤', 'ç„¡æ³•é€£æ¥è³‡æ–™åº«', 'error');
            }
        };

        function addField(type) {
            const defaultData = type === 'text' 
                ? { type: 'text', label: '' } 
                : { type: 'radio_limit', label: '', options: [{label: '', limit: 10}] };
            renderField(defaultData);
        }

        function renderField(data) {
            const container = document.getElementById('fields-container');
            const div = document.createElement('div');
            div.className = "field-item bg-white border-2 border-gray-200 rounded-lg p-4 relative hover:border-blue-300 transition shadow-sm";
            div.dataset.type = data.type;
            
            let html = `
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <span class="text-xs font-bold uppercase tracking-wider text-gray-500 bg-gray-100 px-2 py-1 rounded">
                            ${data.type === 'text' ? 'ğŸ“ ä¸€èˆ¬æ–‡å­—é¡Œ' : 'ğŸ“Š é™é‡é¸é …é¡Œ'}
                        </span>
                        <input type="text" placeholder="è¼¸å…¥é¡Œç›® (ä¾‹å¦‚ï¼š${data.type==='text'?'æ‚¨çš„å§“å':'é¸æ“‡æè¡€æ™‚æ®µ'})" 
                            class="field-label w-full mt-2 text-lg font-bold border-b-2 border-gray-200 focus:border-blue-500 outline-none pb-1 bg-transparent"
                            value="${data.label}">
                    </div>
                    <button onclick="this.closest('.field-item').remove()" class="text-gray-400 hover:text-red-500 ml-4 font-bold text-xl">Ã—</button>
                </div>
            `;

            if (data.type === 'radio_limit') {
                html += `<div class="options-list space-y-2 pl-4 border-l-4 border-indigo-100">`;
                const opts = data.options || [{label:'', limit:10}];
                opts.forEach(opt => {
                    html += getOptionHtml(opt.label, opt.limit);
                });
                html += `</div>`;
                html += `<button onclick="addOption(this)" class="mt-3 text-sm text-indigo-600 hover:text-indigo-800 font-bold flex items-center gap-1">+ æ–°å¢é¸é …</button>`;
            }

            div.innerHTML = html;
            container.appendChild(div);
        }

        function getOptionHtml(label="", limit=10) {
            return `
                <div class="option-row flex items-center gap-2">
                    <span class="text-gray-300">â—</span>
                    <input type="text" placeholder="é¸é …åç¨± (ä¾‹: 13:00)" value="${label}" class="opt-label border p-1 rounded flex-1 focus:ring-1 focus:ring-indigo-500 outline-none">
                    <span class="text-sm text-gray-500">é™:</span>
                    <input type="number" value="${limit}" class="opt-limit border p-1 rounded w-20 text-center focus:ring-1 focus:ring-indigo-500 outline-none">
                    <button onclick="this.parentElement.remove()" class="text-gray-300 hover:text-red-500 px-2">Ã—</button>
                </div>
            `;
        }

        function addOption(btn) {
            const list = btn.previousElementSibling;
            const temp = document.createElement('div');
            temp.innerHTML = getOptionHtml();
            list.appendChild(temp.firstElementChild);
        }

        function saveConfig() {
            const title = document.getElementById('formTitle').value;
            const pwd = document.getElementById('adminPwd').value;
            const fields = [];
            
            document.querySelectorAll('.field-item').forEach(item => {
                const label = item.querySelector('.field-label').value.trim();
                const type = item.dataset.type;
                if (!label) return;

                const fieldData = { label, type };
                
                if (type === 'radio_limit') {
                    fieldData.options = [];
                    item.querySelectorAll('.option-row').forEach(row => {
                        const optLabel = row.querySelector('.opt-label').value.trim();
                        const optLimit = row.querySelector('.opt-limit').value;
                        if (optLabel) {
                            fieldData.options.push({ label: optLabel, limit: parseInt(optLimit) || 0 });
                        }
                    });
                }
                fields.push(fieldData);
            });

            Swal.fire({
                title: 'ç¢ºå®šç™¼ä½ˆï¼Ÿ',
                text: 'é€™å°‡æ›´æ–°å‰å°è¡¨å–®ï¼Œä¸¦åŒæ­¥ Google Sheet æ¬„ä½ã€‚',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ç™¼ä½ˆ',
                confirmButtonColor: '#2563eb'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.showLoading();
                    fetch(API_URL, {
                        method: "POST",
                        headers: { "Content-Type": "text/plain" },
                        body: JSON.stringify({ action: "saveConfig", password: pwd, config: { title, fields } })
                    })
                    .then(r => r.json())
                    .then(res => {
                        if(res.success) Swal.fire('æˆåŠŸ', 'è¡¨å–®å·²æ›´æ–°ï¼', 'success');
                        else Swal.fire('å¤±æ•—', res.message, 'error');
                    });
                }
            });
        }

        function clearDatabase() {
            const pwd = document.getElementById('adminPwd').value;
            Swal.fire({
                title: 'âš ï¸ å±éšªæ“ä½œ',
                text: 'ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å ±åè³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼(é€šå¸¸ç”¨æ–¼é–‹å§‹æ–°çš„ä¸€å ´æ´»å‹•)',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'æ˜¯çš„ï¼Œæ¸…ç©ºå®ƒï¼',
                cancelButtonText: 'å–æ¶ˆ'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.showLoading();
                    fetch(API_URL, {
                        method: "POST",
                        headers: { "Content-Type": "text/plain" },
                        body: JSON.stringify({ action: "clearData", password: pwd })
                    })
                    .then(r => r.json())
                    .then(res => {
                        if(res.success) Swal.fire('å·²é‡ç½®', res.message, 'success');
                        else Swal.fire('éŒ¯èª¤', res.message, 'error');
                    });
                }
            });
        }
    </script>
</body>
</html>
