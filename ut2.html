<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æè¡€æ´»å‹•å ±å</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Zen Maru Gothic', 'Varela Round', sans-serif; }
        .fade-in-up { animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        input[type="radio"]:checked + div { border-color: #f43f5e; background-color: #fff1f2; box-shadow: 0 4px 6px -1px rgba(244, 63, 94, 0.2); }
        input[type="radio"]:checked + div .check-icon { opacity: 1; transform: scale(1); }
    </style>
</head>
<body class="bg-gradient-to-br from-rose-100 via-pink-50 to-orange-50 min-h-screen py-6 px-4 text-gray-700">

    <div class="max-w-md mx-auto relative">
        <div class="absolute -top-10 -left-10 w-40 h-40 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-pulse"></div>
        
        <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl overflow-hidden border border-white fade-in-up relative z-10">
            <div class="bg-gradient-to-r from-rose-400 to-pink-500 p-8 text-center text-white relative">
                <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                <div class="relative z-10">
                    <div class="text-4xl mb-2">ğŸ©¸</div>
                    <h1 id="pageTitle" class="text-2xl font-bold tracking-wide">è¼‰å…¥ä¸­...</h1>
                    <p class="text-pink-100 mt-2 text-sm bg-white/20 inline-block px-3 py-1 rounded-full">âœ¨ è«‹å¡«å¯«ä¸‹æ–¹è³‡è¨Š âœ¨</p>
                </div>
            </div>

            <form id="dynamicForm" class="p-6 space-y-6">
                <div class="text-center py-12 text-rose-400">
                    <div class="inline-block animate-bounce text-4xl mb-2">ğŸ’“</div>
                    <p class="font-bold">è®€å–æœ€æ–°åé¡ä¸­...</p>
                </div>
            </form>

            <div class="p-6 bg-gray-50/50 border-t border-gray-100" id="btnContainer" style="display: none;">
                <button onclick="submitData()" id="submitBtn" class="group w-full bg-gradient-to-r from-rose-500 to-pink-500 text-white font-bold py-4 rounded-2xl shadow-lg hover:shadow-rose-300 hover:scale-[1.02] active:scale-95 transition-all duration-300">
                    ğŸš€ ç«‹å³é€å‡ºå ±å
                </button>
            </div>
        </div>
        
        <p class="text-center text-gray-400 text-xs mt-6 font-medium">Â© UTåœŸåŸ æè¡€ä¸­å¿ƒ â€¢ ç†±è¡€æœ‰ä½ çœŸå¥½ â¤ï¸</p>
    </div>

    <script>
        // â–¼â–¼â–¼ è«‹æ›¿æ›æˆä½ çš„ GAS ç¶²å€ â–¼â–¼â–¼
        const API_URL = "https://script.google.com/macros/s/AKfycbwLe8v81YiqAJCpjJI8hbVMRf7G5SLQ7hWYs0kwj0geVwPZhJRyKeDF40ralFgZTZhu/exec"; 
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        let formStructure = null;

        window.onload = () => {
            fetch(API_URL + "?action=getForm&t=" + new Date().getTime())
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        formStructure = res.form;
                        // â˜…â˜…â˜… æª¢æŸ¥æ™‚é–“ç‹€æ…‹ â˜…â˜…â˜…
                        const status = checkTimeStatus(res.form.startTime, res.form.endTime);
                        if (status === 'open') {
                            renderForm(res.form);
                            document.getElementById('btnContainer').style.display = 'block';
                        } else {
                            renderMessage(status, res.form);
                        }
                    } else {
                        document.getElementById('dynamicForm').innerHTML = `<p class="text-center text-rose-500 font-bold py-10">${res.message}</p>`;
                    }
                })
                .catch(() => document.getElementById('dynamicForm').innerHTML = `<p class="text-center text-gray-500 py-10">é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚</p>`);
        };

        // åˆ¤æ–·ç•¶å‰æ˜¯å¦åœ¨æ´»å‹•æ™‚é–“å…§
        function checkTimeStatus(startStr, endStr) {
            const now = new Date().getTime();
            if (startStr) {
                const start = new Date(startStr).getTime();
                if (now < start) return 'not_started';
            }
            if (endStr) {
                const end = new Date(endStr).getTime();
                if (now > end) return 'ended';
            }
            return 'open';
        }

        // é¡¯ç¤ºæœªé–‹å§‹æˆ–å·²çµæŸçš„ç•«é¢
        function renderMessage(status, form) {
            document.getElementById('pageTitle').innerText = form.title;
            const container = document.getElementById('dynamicForm');
            let icon = '', title = '', desc = '';
            
            if (status === 'not_started') {
                const startDate = form.startTime.replace('T', ' ');
                icon = 'â³';
                title = 'æ´»å‹•å°šæœªé–‹å§‹';
                desc = `é–‹æ”¾å ±åæ™‚é–“ï¼š<br><span class="font-bold text-rose-500">${startDate}</span>`;
            } else {
                icon = 'ğŸ';
                title = 'æ´»å‹•å·²ç¶“çµæŸ';
                desc = 'è¬è¬å¤§å®¶çš„ç†±æƒ…åƒèˆ‡ï¼<br>ä¸‹æ¬¡è«‹æ—©é»ä¾†å–” â¤ï¸';
            }

            container.innerHTML = `
                <div class="text-center py-12 px-4">
                    <div class="text-6xl mb-4 animate-bounce">${icon}</div>
                    <h2 class="text-2xl font-bold text-gray-700 mb-3">${title}</h2>
                    <p class="text-gray-500 leading-relaxed">${desc}</p>
                </div>
            `;
            // éš±è—æäº¤æŒ‰éˆ•
            document.getElementById('btnContainer').style.display = 'none';
        }

        function renderForm(data) {
            document.getElementById('pageTitle').innerText = data.title;
            const container = document.getElementById('dynamicForm');
            container.innerHTML = '';

            data.fields.forEach((field, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = "pop-in";
                wrapper.style.animationDelay = `${index * 100}ms`;
                wrapper.innerHTML = `<label class="block text-lg font-bold mb-3 text-gray-700 flex items-center gap-2"><span class="w-1.5 h-6 bg-rose-400 rounded-full inline-block"></span>${field.label}</label>`;
                
                if (field.type === 'text') {
                    wrapper.innerHTML += `<input type="text" name="${field.id}" class="w-full px-5 py-3 bg-gray-50 border-2 border-gray-100 rounded-2xl focus:bg-white focus:border-rose-300 focus:ring-4 focus:ring-rose-100 outline-none transition-all duration-300" placeholder="è«‹è¼¸å…¥${field.label}...">`;
                } else if (field.type === 'radio_limit') {
                    let opts = `<div class="grid grid-cols-1 gap-3">`;
                    field.options.forEach(opt => {
                        const isFull = opt.remaining <= 0;
                        const percent = (opt.current / opt.limit) * 100;
                        let color = percent > 85 || isFull ? 'bg-rose-400' : (percent > 50 ? 'bg-amber-400' : 'bg-emerald-400');
                        opts += `
                            <label class="relative cursor-pointer group">
                                <input type="radio" name="${field.id}" value="${opt.label}" ${isFull ? 'disabled' : ''} class="peer sr-only">
                                <div class="p-4 rounded-2xl border-2 border-gray-100 bg-white hover:border-rose-200 transition-all duration-200 ${isFull ? 'opacity-60 bg-gray-50 grayscale' : ''}">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="flex items-center gap-2"><span class="text-lg font-bold">${opt.label}</span><span class="check-icon opacity-0 transform scale-50 transition-all duration-300 text-rose-500">âœ“</span></div>
                                        <span class="text-xs font-bold px-2 py-1 rounded-lg ${isFull ? 'bg-gray-200 text-gray-500' : 'bg-rose-100 text-rose-600'}">${isFull ? 'é¡æ»¿' : `å‰© ${opt.remaining} å`}</span>
                                    </div>
                                    <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden"><div class="${color} h-2 rounded-full transition-all duration-1000" style="width: ${percent}%"></div></div>
                                </div>
                            </label>`;
                    });
                    wrapper.innerHTML += opts + `</div>`;
                }
                container.appendChild(wrapper);
            });
        }

        function submitData() {
            const answers = {};
            let isValid = true;
            formStructure.fields.forEach(field => {
                if (field.type === 'text') {
                    const el = document.querySelector(`input[name="${field.id}"]`);
                    const val = el ? el.value.trim() : "";
                    if(!val) { isValid = false; el.classList.add('border-rose-500', 'bg-rose-50'); setTimeout(() => el.classList.remove('border-rose-500', 'bg-rose-50'), 1000); }
                    answers[field.id] = val;
                } else {
                    const checked = document.querySelector(`input[name="${field.id}"]:checked`);
                    if(!checked) isValid = false;
                    answers[field.id] = checked ? checked.value : "";
                }
            });

            if (!isValid) return Swal.fire({ icon: 'warning', title: 'å“å‘€ï¼', text: 'é‚„æœ‰æ¬„ä½æ²’å¡«å¯«å–”ï½', confirmButtonColor: '#f43f5e' });
            
            const btnContainer = document.getElementById('btnContainer');
            const originalBtn = btnContainer.innerHTML;
            btnContainer.innerHTML = `<div class="text-center py-4 bg-rose-50 rounded-2xl border border-rose-100 animate-pulse"><span class="text-rose-500 font-bold">ğŸ’« æ­£åœ¨å‚³é€æ„›å¿ƒé›»æ³¢...</span></div>`;
            
            fetch(API_URL, { method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify({ action: "submit", answers: answers }) })
            .then(r => r.json()).then(res => {
                if(res.success) Swal.fire({ title: 'å ±åæˆåŠŸï¼ğŸ‰', text: 'è¬è¬æ‚¨çš„ç†±è¡€æ„›å¿ƒï¼', icon: 'success', confirmButtonColor: '#f43f5e' }).then(() => location.reload());
                else Swal.fire({ title: 'ç³Ÿç³•...', text: res.message, icon: 'error' }).then(() => location.reload());
            })
            .catch(() => {
                Swal.fire('å—šå—š...', 'ç¶²è·¯å¥½åƒæœ‰é»å•é¡Œ', 'error');
                btnContainer.innerHTML = originalBtn;
            });
        }
    </script>
</body>
</html>
