<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>活動報名</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-red-50 min-h-screen py-8 px-4">
    <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="bg-red-600 p-6 text-center text-white"><h1 id="pageTitle" class="text-2xl font-bold">載入中...</h1></div>
        <form id="dynamicForm" class="p-6 space-y-6 text-center"><p>讀取中...</p></form>
        <div class="p-4 bg-gray-50"><button onclick="submitData()" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg shadow">送出</button></div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyVbDoPrrdD8enuDWxaies6Pr9u6myo6DAGBvjnnPKqorPDWxO3QKYIj6ODb8zK1uebEA/exec"; // ★記得換★
        let formStructure = null;

        window.onload = () => {
            fetch(API_URL + "?action=getForm").then(r => r.json()).then(res => {
                if (res.success) {
                    formStructure = res.form;
                    renderForm(res.form);
                } else document.getElementById('dynamicForm').innerHTML = res.message;
            });
        };

        function renderForm(data) {
            document.getElementById('pageTitle').innerText = data.title;
            const container = document.getElementById('dynamicForm');
            container.innerHTML = '';

            data.fields.forEach(field => {
                const wrapper = document.createElement('div');
                wrapper.innerHTML = `<label class="block text-lg font-bold mb-2 text-left">${field.label}</label>`;
                
                if (field.type === 'text') {
                    // input 的 name 改用 ID
                    wrapper.innerHTML += `<input type="text" name="${field.id}" class="w-full border p-2 rounded">`;
                } else if (field.type === 'radio_limit') {
                    let opts = `<div class="space-y-2">`;
                    field.options.forEach(opt => {
                        const isFull = opt.remaining <= 0;
                        opts += `
                            <label class="block border p-3 rounded flex justify-between ${isFull ? 'bg-gray-100 opacity-50' : 'bg-white'}">
                                <div><input type="radio" name="${field.id}" value="${opt.label}" ${isFull ? 'disabled' : ''}> ${opt.label}</div>
                                <span class="text-sm font-bold ${isFull ? 'text-red-500':'text-green-500'}">${isFull ? '額滿' : '餘 '+opt.remaining}</span>
                            </label>`;
                    });
                    wrapper.innerHTML += opts + `</div>`;
                }
                container.appendChild(wrapper);
            });
        }

        function submitData() {
            const answers = {};
            let isValid = true;
            formStructure.fields.forEach(field => {
                // 用 ID 去抓值
                if (field.type === 'text') {
                    const val = document.querySelector(`input[name="${field.id}"]`).value;
                    if(!val) isValid = false;
                    answers[field.id] = val;
                } else {
                    const checked = document.querySelector(`input[name="${field.id}"]:checked`);
                    if(!checked) isValid = false;
                    answers[field.id] = checked ? checked.value : "";
                }
            });

            if (!isValid) return Swal.fire('提示', '請填寫完整', 'warning');
            
            Swal.showLoading();
            fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({ action: "submit", answers: answers })
            })
            .then(r => r.json())
            .then(res => {
                if(res.success) Swal.fire('成功', '報名完成', 'success').then(() => location.reload());
                else Swal.fire('失敗', res.message, 'error').then(() => location.reload());
            });
        }
    </script>
</body>
</html>
