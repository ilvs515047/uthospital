<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>活動報名</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-red-50 min-h-screen py-8 px-4 font-sans text-gray-700">

    <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="bg-red-600 p-6 text-center text-white">
            <h1 id="pageTitle" class="text-2xl font-bold">載入中...</h1>
            <p class="text-red-100 mt-2 text-sm">請填寫下方資訊</p>
        </div>

        <form id="dynamicForm" class="p-6 space-y-6">
            <div class="text-center py-10 text-gray-400">正在讀取最新名額...</div>
        </form>

        <div class="p-4 bg-gray-50 border-t" id="btnContainer">
            <button onclick="submitData()" id="submitBtn" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg shadow hover:bg-red-700 transition disabled:bg-gray-400">
                送出報名
            </button>
        </div>
    </div>

    <script>
        // ▼▼▼ 請替換成你的 GAS 網址 ▼▼▼
        const API_URL = "https://script.google.com/macros/s/AKfycbzdnu5QfsXLkXg0fXXte0lzTGtuPAR4Ewi0YRbos-Xp-J84IZhj3jv-7lEaRD-SAwuQdQ/exec"; 
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        let formStructure = null;

        window.onload = () => {
            // ★★★ 加上 &t=... 防止瀏覽器快取舊資料 ★★★
            fetch(API_URL + "?action=getForm&t=" + new Date().getTime())
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        formStructure = res.form;
                        renderForm(res.form);
                    } else {
                        document.getElementById('dynamicForm').innerHTML = `<p class="text-center text-red-500">${res.message}</p>`;
                    }
                })
                .catch(() => document.getElementById('dynamicForm').innerHTML = "連線失敗");
        };

        function renderForm(data) {
            document.getElementById('pageTitle').innerText = data.title;
            const container = document.getElementById('dynamicForm');
            container.innerHTML = '';

            data.fields.forEach(field => {
                const wrapper = document.createElement('div');
                wrapper.innerHTML = `<label class="block text-lg font-bold mb-2 text-left">${field.label}</label>`;
                
                if (field.type === 'text') {
                    wrapper.innerHTML += `<input type="text" name="${field.id}" class="w-full border p-2 rounded focus:ring-2 focus:ring-red-500 outline-none" placeholder="請輸入...">`;
                } else if (field.type === 'radio_limit') {
                    let opts = `<div class="space-y-2">`;
                    field.options.forEach(opt => {
                        const isFull = opt.remaining <= 0;
                        opts += `
                            <label class="block border p-3 rounded flex justify-between cursor-pointer transition hover:bg-red-50 ${isFull ? 'bg-gray-100 opacity-50 cursor-not-allowed' : 'bg-white'}">
                                <div class="flex items-center gap-2">
                                    <input type="radio" name="${field.id}" value="${opt.label}" ${isFull ? 'disabled' : ''} class="accent-red-600"> 
                                    <span>${opt.label}</span>
                                </div>
                                <span class="text-sm font-bold ${isFull ? 'text-red-500':'text-green-600'}">${isFull ? '額滿' : '餘 '+opt.remaining}</span>
                            </label>`;
                    });
                    wrapper.innerHTML += opts + `</div>`;
                }
                container.appendChild(wrapper);
            });
        }

        function submitData() {
            const btn = document.getElementById('submitBtn');
            const answers = {};
            let isValid = true;

            formStructure.fields.forEach(field => {
                if (field.type === 'text') {
                    const el = document.querySelector(`input[name="${field.id}"]`);
                    const val = el ? el.value.trim() : "";
                    if(!val) { isValid = false; if(el) el.classList.add('border-red-500'); }
                    else { if(el) el.classList.remove('border-red-500'); }
                    answers[field.id] = val;
                } else {
                    const checked = document.querySelector(`input[name="${field.id}"]:checked`);
                    if(!checked) isValid = false;
                    answers[field.id] = checked ? checked.value : "";
                }
            });

            if (!isValid) return Swal.fire('提示', '請填寫完整資料', 'warning');
            
            // ★★★ 修改處：讓按鈕消失，並顯示處理中文字 ★★★
            btn.style.display = "none"; // 隱藏按鈕
            
            // 建立一個臨時的提示文字
            const loadingMsg = document.createElement('div');
            loadingMsg.id = 'loadingMsg';
            loadingMsg.className = 'text-center text-red-600 font-bold py-3 animate-pulse';
            loadingMsg.innerHTML = '⏳ 資料傳送中，請稍候...';
            btn.parentElement.appendChild(loadingMsg);
            
            fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify({ action: "submit", answers: answers })
            })
            .then(r => r.json())
            .then(res => {
                if(res.success) {
                    Swal.fire('成功', '報名完成！', 'success').then(() => location.reload());
                } else {
                    Swal.fire('哎呀', res.message, 'error').then(() => location.reload());
                }
            })
            .catch(() => {
                Swal.fire('錯誤', '網路異常', 'error');
                // 如果失敗，把按鈕叫回來，讓使用者可以重試
                btn.style.display = "block";
                const msg = document.getElementById('loadingMsg');
                if(msg) msg.remove();
            });
        }
    </script>
</body>
</html>
